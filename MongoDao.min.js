"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var n=t(require("moment")),e=t(require("encaps-proxy")),o=t(require("mongodb")),i=t(require("async")),c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(t,n){return t(n={exports:{}},n.exports),n.exports}var l=r((function(t){(function(){var o,i,r,l;l=n,r=e,i=c.mongoLogger||console,o=class extends r{constructor(t,n){super(t,n),this.dbname=t.url.substring(t.url.lastIndexOf("/")+1,t.url.lastIndexOf("?"))}proxy(t){var n;return n=this,"connect"===t.name?function(){return t.apply(n.target,arguments)}:function(){var e,o,c,r,s,u;[...s]=arguments,e=s.pop(),u=l(),r="",r=(r=function(){var t,n,e;for(e=[],t=0,n=s.length;t<n;t++)c=s[t],e.push(JSON.stringify(c));return e}().join(",")).length>100?r.substring(0,200)+"...":r,s.push((function(){var o;return o=l(),i.info(`${n.dbname}.${n.collection}.${t.name}:${r}  --${o-u}ms`),e.apply(this,arguments)}));try{return t.apply(n.target,s)}catch(c){return o=c,(i.trace||i.error)(`${n.dbname}.${n.collection}.${t.name}:${r}  --${l()-u}ms\n${o.stack}`),e(o)}}}},t.exports=o}).call(c)})),s=r((function(t){(function(){var n,e,r,l,s;s=o.MongoClient,o.InsertManyOptions,r=o.ObjectId,l=i,e=c.mongoLogger||console,n=class{constructor(t,n,e){this.url=t,this.collection=n,this.DB_OPTS=e,this.database=this.url.substring(this.url.lastIndexOf("/")+1,this.url.lastIndexOf("?"))}connect(t){var n,o;n=(n,o)=>{var i;o||e.error("数据库连接获取失败");try{return t(n,o.db(this.database))}catch(t){return i=t,e.error(i.stack)}};try{return s.connect(this.url,this.DB_OPTS,n)}catch(t){return o=t,e.error(o.stack)}}closeConnectFun(t,n){return function(){var e;return null!=t&&"function"==typeof t.close&&t.close(),null!=(e=n)?e.apply(null,arguments):void 0}}insert(t,n){return this.connect((e,o)=>{var i;return i=this.closeConnectFun(o,n),e?i(e):Array.isArray(t)?(t.forEach((function(t){return t._id&&"string"==typeof t._id&&(t._id=r(t._id))})),o.collection(this.collection).insert(t,i)):t instanceof Object?(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),o.collection(this.collection).insertOne(t,i)):i("param Invalid")})}addOrUpdate(t,n){var e;return t instanceof Object||Array.isArray(t)?(e=this,this.connect((o,i)=>o?n(o):Array.isArray(t)?l.each(t,(function(t,n){return t._id&&"string"==typeof t._id&&(t._id=r(t._id)),i.collection(e.collection).findOne({_id:t._id},(function(o,c){return c?i.collection(e.collection).updateOne({_id:t._id},{$set:t},n):i.collection(e.collection).insertOne(t,n)}))}),(function(t){return null!=i&&"function"==typeof i.close&&i.close(),n(t)})):t instanceof Object?(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),i.collection(e.collection).findOne({_id:t._id},(function(o,c){return c?i.collection(e.collection).updateOne({_id:t._id},{$set:t},(function(t){return null!=i&&"function"==typeof i.close&&i.close(),n(t)})):i.collection(e.collection).insertOne(t,(function(t){return null!=i&&"function"==typeof i.close&&i.close(),n(t)}))}))):void 0)):n(null)}delete(t,n){return this.connect((e,o)=>{var i;return i=this.closeConnectFun(o,n),e?i(e):(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),o.collection(this.collection).countDocuments(t,(n,e)=>1===e?o.collection(this.collection).removeOne(t,i):e>1?o.collection(this.collection).removeMany(t,i):i(null,0)))})}update(t,n,e){return this.connect((o,i)=>{var c;return c=this.closeConnectFun(i,e),o?c(o):(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),n._id&&delete n._id,i.collection(this.collection).countDocuments(t,(e,o)=>1===o?i.collection(this.collection).updateOne(t,n,c):o>1?i.collection(this.collection).updateMany(t,n,c):c(null,0)))})}selectOne(t,n){return this.connect((e,o)=>{var i;return i=this.closeConnectFun(o,n),e?i(e):(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),o.collection(this.collection).findOne(t,i))})}selectBySortOrLimit(t,n,e,o){return this.connect((i,c)=>i?o(i):(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),-1===e?c.collection(this.collection).find(t).sort(n).toArray((function(t,n){return null!=c&&"function"==typeof c.close&&c.close(),o(t,n)})):c.collection(this.collection).find(t).sort(n).limit(e).toArray((function(t,n){return null!=c&&"function"==typeof c.close&&c.close(),o(t,n)}))))}selectBySortOrSkipOrLimit(t,n,e,o,i){return this.connect((c,l)=>c?i(c):(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),-1===o?l.collection(this.collection).find(t).skip(e).sort(n).toArray((function(t,n){return null!=l&&"function"==typeof l.close&&l.close(),i(t,n)})):l.collection(this.collection).find(t).skip(e).limit(o).sort(n).toArray((function(t,n){return null!=l&&"function"==typeof l.close&&l.close(),i(t,n)}))))}selectList(t,n){return this.connect((e,o)=>e?n(e):(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),o.collection(this.collection).find(t).toArray((function(t,e){return null!=o&&"function"==typeof o.close&&o.close(),n(t,e)}))))}count(t,n){return this.connect((e,o)=>{var i;return i=this.closeConnectFun(o,n),e?i(e):(t._id&&"string"==typeof t._id&&(t._id=r(t._id)),o.collection(this.collection).countDocuments(t,i))})}aggregate(){var t,n;if([...n]=arguments,n.length)return t=n.pop(),this.connect((e,o)=>{var i;return i=this.closeConnectFun(o,t),n.push(i),e?i(e):o.collection(this.collection).aggregate.apply(o.collection(this.collection),n)})}},t.exports=n}).call(c)})),u=r((function(t){(function(){var n,e,o;e=l,n=s,o=class{constructor(t,o){var i,c,r,l,s,u,a;if(!t)throw"未进行数据库配置";if(!o)throw"请传入实例化库和集合";for(r in s=`mongodb://${t.username}:${t.password}@${t.hostName}:${t.port}/`,u="?"+t.auth,o)if(a=o[r],this[r]={},Array.isArray(a))for(c=0,l=a.length;c<l;c++)i=a[c],this[r][i]=new e(new n(s+r+u,i,t.DB_OPTS));else this[r][a]=new e(new n(s+r+u,a,t.DB_OPTS))}},t.exports=o}).call(c)}));module.exports=u;
